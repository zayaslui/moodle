<?php
   if (!isset($user->htmleditor)) {
       $user->htmleditor = 1;
   }
   if (!isset($user->picture)) {
       $user->picture = NULL;
   }
   if (empty($user->lang)) {
       $user->lang = $CFG->lang;
   }

?>

<form method="post" enctype="multipart/form-data" action="edit.php">
<table cellpadding=9 cellspacing=0 >
<?php
if (isadmin()) {
    $theadmin = get_admin();
    $adminself = (($theadmin->id == $USER->id) and ($USER->id == $user->id));
    echo "<tr valign=top>";
    echo "<td><p>".get_string("username").":</td>";
    if ($adminself || is_internal_auth() ){
        echo "<td><input type=\"text\" name=\"username\" size=20 value=\"";
        p($user->username);
        echo "\">";
        if (isset($err["username"])) formerr($err["username"]);
    } else {
        echo "<td>";
        p($user->username);
        echo "<input type=\"hidden\" name=\"username\" value=\"";
        p($user->username);
        echo "\">";
    }
    echo "</td>";
    echo "</tr>";

    if ($adminself || is_internal_auth() ){
        echo "<tr valign=top>";
        echo "<td><p>".get_string("newpassword").":</td>";
        echo "<td><input type=\"text\" name=\"newpassword\" size=20 value=\"";
        if (isset($user->newpassword)) p($user->newpassword);
            echo "\">";
        if (isset($err["newpassword"])) {
            formerr($err["newpassword"]);
        } else if (empty($user->newpassword)) {
            echo " (".get_string("leavetokeep").")";
        }
        echo "</td>";
        echo "</tr>";
        echo "<tr><td colspan=2><HR></td></tr>";
    }
}
?>
<tr valign=top>
    <td><p><?php print_string("firstname") ?>:</td>
    <td><input type="text" name="firstname" size="30" maxlength="20" value="<?php p($user->firstname) ?>">
    <?php if (isset($err["firstname"])) formerr($err["firstname"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("lastname") ?>:</td>
    <td><input type="text" name="lastname" size="30" maxlength="20" value="<?php p($user->lastname) ?>">
    <?php if (isset($err["lastname"])) formerr($err["lastname"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("email") ?>:</td>
    <td><input type="text" name="email" size="30" maxlength="100" value="<?php p($user->email) ?>">
    <?php if (isset($err["email"])) formerr($err["email"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("emaildisplay") ?>:</td>
    <td><?php 
    $choices["0"] = get_string("emaildisplayno");
    $choices["1"] = get_string("emaildisplayyes");
    $choices["2"] = get_string("emaildisplaycourse");
    choose_from_menu ($choices, "maildisplay", $user->maildisplay, "") ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("emailformat") ?>:</td>
    <td><?php 
    unset($choices);
    $choices["0"] = get_string("textformat");
    $choices["1"] = get_string("htmlformat");
    choose_from_menu ($choices, "mailformat", $user->mailformat, "") ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("autosubscribe") ?>:</td>
    <td><?php 
    unset($choices);
    $choices["1"] = get_string("autosubscribeyes");
    $choices["0"] = get_string("autosubscribeno");
    choose_from_menu ($choices, "autosubscribe", $user->autosubscribe, "") ?>
    </td>
</tr>
<?php if ($CFG->htmleditor) { ?>
<tr valign=top>
    <td><p><?php print_string("textediting") ?>:</td>
    <td><?php 
    unset($choices);
    $choices["0"] = get_string("texteditor");
    $choices["1"] = get_string("htmleditor");
    choose_from_menu ($choices, "htmleditor", $user->htmleditor, "") ?>
    </td>
</tr>
<?php } ?>
<tr valign=top>
    <td><p><?php print_string("city") ?>:</td>
    <td><input type="text" name="city" size="25" maxlength="20" value="<?php p($user->city) ?>">
    <?php if (isset($err["city"])) formerr($err["city"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("country") ?>:</td>
    <td><?php 

    if (!$user->country and $CFG->country) {
        $user->country = $CFG->country;
    }
    
    choose_from_menu (get_list_of_countries(), "country", $user->country, get_string("selectacountry")."...", "", "") ?>
    <?php if (isset($err["country"])) formerr($err["country"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("preferredlanguage") ?>:</td>
    <td><?php if ($languages = get_list_of_languages()) {
               if (!$user->lang) {
                   $user->lang = $CFG->lang;
               }
               choose_from_menu ($languages, "lang", $user->lang, "", "", "");
           }
           if (isset($err["lang"])) formerr($err["lang"]);
        ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("timezone") ?>:</td>
    <td><?php
       if (abs($user->timezone) > 13) {
           $user->timezone = 99;
       }
       $timenow = time();

       for ($tz = -26; $tz <= 26; $tz++) {
           $zone = (float)$tz/2.0;
           $usertime = $timenow + ($tz * 1800);
           if ($tz == 0) {
               $timezones["$zone"] = gmstrftime("%a, %I:%M %p", $usertime)." (GMT)";
           } else if ($tz < 0) {
               $timezones["$zone"] = gmstrftime("%a, %I:%M %p", $usertime)." (GMT$zone)";
           } else {
               $timezones["$zone"] = gmstrftime("%a, %I:%M %p", $usertime)." (GMT+$zone)";
           }
       }

       choose_from_menu ($timezones, "timezone", $user->timezone, get_string("serverlocaltime"), "", "99");

       echo "(".get_string("currentlocaltime").")";
    ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("userdescription") ?>:</td>
    <td><?php if (isset($err["description"])) {
               formerr($err["description"]);
               echo "<br />";
           } ?>
    <textarea name=description cols=50 rows=10 wrap=virtual><?php p($user->description) ?></textarea> 
    <?php helpbutton("text", get_string("helptext")) ?>
    </td>
</tr>
<tr>
    <td colspan=2><br /><b><?php print_string("followingoptional") ?>:</b></td>
</tr>


<?php 
    $maxbytes = get_max_upload_file_size($CFG->maxbytes, $course->maxbytes);
    if (!empty($CFG->gdversion) and $maxbytes and empty($CFG->disableuserimages)) {  
?>
<tr valign=top>
    <td><p><?php print_string("currentpicture") ?>:</td>
    <td>
       <?php print_user_picture($user->id, $course->id, $user->picture, false, false, false); 
             if ($user->picture) {
                 echo '&nbsp;&nbsp;<input type="checkbox" name="deletepicture" value="1">';
                 print_string("delete");
             }
       ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("newpicture") ?>:</td>
    <td>
    <input type="hidden" name="MAX_FILE_SIZE" value="<?php echo $maxbytes ?>">
    <input type="file" name="imagefile" size=40>
    <?php helpbutton("picture", get_string("helppicture"));
       print_string("maxsize", "", display_size($maxbytes)); 
       if (isset($err["imagefile"])) formerr($err["imagefile"]);
    ?>
    </td>
</tr>
<?php }  ?>

<tr valign=top>
    <td><p><?php print_string("webpage") ?>:</td>
    <td><input type="text" name="url" size="50" maxlength="255" value="<?php p($user->url) ?>">
    <?php if (isset($err["url"])) formerr($err["url"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("icqnumber") ?>:</td>
    <td><input type="text" name="icq" size="25" maxlength="15" value="<?php p($user->icq) ?>">
    <?php if (isset($err["icq"])) formerr($err["icq"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("idnumber") ?>:</td>
    <td><input type="text" name="idnumber" size="25" maxlength="12" value="<?php p($user->idnumber) ?>"> <?php p($teacheronly) ?>
    <?php if (isset($err["idnumber"])) formerr($err["idnumber"]); ?>
    </td>
</tr>
<?php if (isadmin()) {  ?>
<tr valign=top>
    <td><p><?php print_string("institution") ?>:</td>
    <td><input type="text" name="institution" size="25" maxlength="40" value="<?php p($user->institution) ?>"> <?php p($teacheronly) ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("department") ?>:</td>
    <td><input type="text" name="department" size="25" maxlength="30" value="<?php p($user->department) ?>"> <?php p($teacheronly) ?>
    </td>
</tr>
<?php } ?>
<tr valign=top>
    <td><p><?php print_string("phone") ?> 1:</td>
    <td><input type="text" name="phone1" size="25" maxlength="20" value="<?php p($user->phone1) ?>"> <?php p($teacheronly) ?>
    <?php if (isset($err["phone1"])) formerr($err["phone1"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("phone") ?> 2:</td>
    <td><input type="text" name="phone2" size="25" maxlength="20" value="<?php p($user->phone2) ?>"> <?php p($teacheronly) ?>
    <?php if (isset($err["phone2"])) formerr($err["phone2"]); ?>
    </td>
</tr>
<tr valign=top>
    <td><p><?php print_string("address") ?>:</td>
    <td><input type="text" name="address" size="25" maxlength="70" value="<?php p($user->address) ?>"> <?php p($teacheronly) ?>
    <?php if (isset($err["address"])) formerr($err["address"]); ?>
    </td>
</tr>
<tr>
    <td></td>
    <td align=right><input type="submit" value="<?php print_string("updatemyprofile") ?>"></td>
</table>
<input type="hidden" name="course" value="<?php p($course->id) ?>">
<input type="hidden" name="id" value="<?php p($user->id) ?>"> 
</form>
