<?PHP //$Id$
    //This page prints the backup todo list to see everything

    //Check login   
    require_login();

    if (!empty($course->id)) {
        if (!isteacheredit($course->id)) {
            error("You need to be a teacher or admin user to use this page.", "$CFG->wwwroot/login/index.php");
        }
    } else {
        if (!isadmin()) {
            error("You need to be an admin user to use this page.", "$CFG->wwwroot/login/index.php");
        }
    }


    //Check site
    if (!$site = get_site()) {
        error("Site not found!");
    }

   //Checks for the required files/functions to backup every mod
    //And check if there is data about it
    $count = 0;
    if ($allmods = get_records("modules") ) {
        foreach ($allmods as $mod) {
            $modname = $mod->name;
            $modfile = "$CFG->dirroot/mod/$modname/backuplib.php";
            $modbackup = $modname."_backup_mods";
            $modcheckbackup = $modname."_check_backup_mods";
            if (file_exists($modfile)) {
               include_once($modfile);
               if (function_exists($modbackup) and function_exists($modcheckbackup)) {
                   $var = "exists_".$modname;
                   $$var = true;
                   $count++;
               }
            }
            //Check data
            //Check module info
            $var = "backup_".$modname;
            if (!isset($$var)) {
                $$var = 1;
            }
            //Check include user info
            $var = "backup_user_info_".$modname;
            if (!isset($$var)) {
                $$var = 1;
            }
        }
    }

    //Check other parameters
    if (!isset($backup_users)) {
        $backup_users = 1;
    }
   
    if (!isset($backup_logs)) {
        $backup_logs = 0;
    }

    if (!isset($backup_user_files)) {
        $backup_user_files = 1;
   }

    if (!isset($backup_course_files)) {
        $backup_course_files = 2;
    }

    if ($count == 0) {
        notice("No backupable modules are installed!");
    }
?>

<form name="form" method="post" action="<?php echo $ME ?>">
<table cellpadding=5>
<?php

    //Now print the Backup Name tr
    echo "<tr>";
    echo "<td align=\"right\"><P><B>";
    echo get_string("name").":";
    echo "</B></td><td>";
    //Calculate the backup string

    //Calculate the backup word
    //Take off some characters in the filename !!
    $takeoff = array(" ", ":", "/", "\\", "|");
    $backup_word = str_replace($takeoff,"_",strtolower(get_string("backupfilename")));
    //If non-translated, use "backup"
    if (substr($backup_word,0,1) == "[") {
        $backup_word= "backup";
    }

    //Calculate the date format string
    $backup_date_format = str_replace(" ","_",get_string("backupnameformat"));
    //If non-translated, use "%Y%m%d-%H%M"
    if (substr($backup_date_format,0,1) == "[") {
        $backup_date_format = "%%Y%%m%%d-%%H%%M";
    }

    //Calculate the shortname
    $backup_shortname = clean_filename($course->shortname);
    if (empty($backup_shortname) or $backup_shortname == '_' ) {
        $backup_shortname = $course->id;
    }

    //Calculate the final backup filename
    //The backup word
    $backup_name = $backup_word."-";
    //The shortname
    $backup_name .= strtolower($backup_shortname)."-";
    //The date format
    $backup_name .= userdate(time(),$backup_date_format,99,false);
    //The extension
    $backup_name .= ".zip";

    //Add as text field
    echo "<input type=\"text\" name=\"backup_name\" size=\"40\" value=\"".$backup_name."\">";
    echo "</td></tr>";

    //Calculate the backup unique code to allow simultaneus backups (to define
    //the temp-directory name and records in backup temp tables
    $backup_unique_code = time();
    //Add as hidden name
    echo "<input type=\"hidden\" name=\"backup_unique_code\" value=\"".$backup_unique_code."\">";
    
    //Line
    echo "<tr><td colspan=\"2\"><hr noshade size=\"1\"></td></tr>";

    //Now print the To Do list
    echo "<tr>";    
    echo "<td colspan=\"2\" align=\"center\"><P><B>";

    //Here we check if backup_users = None. Then, we switch off every module
    //user info, user_files, logs and exercises and workshop backups. A Warning is showed to
    //inform the user.
    if ($backup_users == 2) {
        if ($allmods = get_records("modules") ) {
            foreach ($allmods as $mod) {
                $modname = $mod->name;
                $var = "backup_user_info_".$modname;
                if (isset($$var)) {
                    $$var = 0;
                }
                $var = "backup_".$modname;
                if (isset($$var)) {
                    if ($modname == "exercise" || $modname == "workshop") {
                        $$var = 0;
                    }
                }
            }
        $backup_user_files = 0;
        $backup_logs = 0;
        }
        print_simple_box("<font color=\"red\">".get_string("backupnoneusersinfo")."</font>","center", "70%", "$THEME->cellheading", "20", "noticebox");
        echo "<hr noshade size=\"1\">";
    }

    echo get_string("backupdetails").":";
    echo "</td></tr>";

    //This is tha align to every ingo table                
    $table->align = array ("LEFT","RIGHT");

    if ($allmods = get_records("modules") ) {
        foreach ($allmods as $mod) {
            $modname = $mod->name;
            $modbackup = $modname."_backup_mods";
            //If exists the lib & function
            $var = "exists_".$modname;
            if (isset($$var) && $$var) {
                //Add hidden fields
                $var = "backup_".$modname;
                echo "<input type=\"hidden\" name=\"".$var."\" value=\"".$$var."\">";
                $var = "backup_user_info_".$modname;
                echo "<input type=\"hidden\" name=\"".$var."\" value=\"".$$var."\">";
                $var = "backup_".$modname;
                //Only if selected
                if ($$var == 1) {
                    //Print the full tr
                    echo "<tr>";
                    echo "<td colspan=\"2\"><P><B>";
                    //Print the mod name
                    echo "<li>".get_string("include")." ".get_string("modulenameplural",$modname)." ";
                    //Now look for user-data status
                    $backup_user_options[0] = get_string("withoutuserdata"); 
                    $backup_user_options[1] = get_string("withuserdata");
                    $var = "backup_user_info_".$modname;
                    //Print the user info
                    echo $backup_user_options[$$var]."<P>";
                    //Call the check function to show more info
                    $modcheckbackup = $modname."_check_backup_mods";
                    $table->data = $modcheckbackup($id,$$var,$backup_unique_code);
                    print_table($table); 
                    echo "</td></tr>";
                }
            }
        }
        //Line
        echo "<tr><td colspan=\"2\"><hr noshade size=\"1\"></td></tr>";

        //Now print the Users tr
        echo "<tr>";
        echo "<td colspan=\"2\"><P><B>";
        $user_options[0] = get_string("includeallusers");
        $user_options[1] = get_string("includecourseusers");
        $user_options[2] = get_string("includenoneusers");
        echo "<li>".$user_options[$backup_users]."<P>";
        //Add as hidden name
        echo "<input type=\"hidden\" name=\"backup_users\" value=\"".$backup_users."\">";
        //Print info
        $table->data = user_check_backup($id,$backup_unique_code,$backup_users);  
        print_table($table); 
        echo "</td></tr>";

        //Now print the Logs tr conditionally
        if ($backup_logs) {
            echo "<tr>";
            echo "<td colspan=\"2\"><P><B>";
            echo "<li>".get_string("includelogentries")."<P>";
            //Print info
            $table->data = log_check_backup($id);
            print_table($table);
            echo "</td></tr>";
        }
        //Add as hidden name
        echo "<input type=\"hidden\" name=\"backup_logs\" value=\"".$backup_logs."\">";

        //Now print the User Files tr conditionally
        if ($backup_user_files) {
            echo "<tr>";
            echo "<td colspan=\"2\"><P><B>";
            echo "<li>".get_string("includeuserfiles")."<P>";
            //Print info
            $table->data = user_files_check_backup($id,$backup_unique_code);
            print_table($table);
            echo "</td></tr>";
        }
        //Add as hidden name
        echo "<input type=\"hidden\" name=\"backup_user_files\" value=\"".$backup_user_files."\">";

        //Now print the Course Files tr conditionally
       if ($backup_course_files) {
            echo "<tr>";
            echo "<td colspan=\"2\"><P><B>";
            echo "<li>".get_string("includecoursefiles")."<P>";
            //Print info
            $table->data = course_files_check_backup($id,$backup_unique_code);
            print_table($table);
            echo "</td></tr>";
        }
        //Add as hidden name
        echo "<input type=\"hidden\" name=\"backup_course_files\" value=\"".$backup_course_files."\">";
    }
?>
</table>
<BR>
<CENTER>
<input type="hidden" name=id     value="<?php  p($id) ?>">
<input type="hidden" name=launch value="execute">
<input type="submit" value="<?php  print_string("continue") ?>">
<input type="submit" name=cancel value="<?php  print_string("cancel") ?>">
</CENTER>
</FORM>
